CREATE DATABASE fitbody;

CREATE TABLE accounts(
  account_id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(254) NOT NULL,
  email VARCHAR(254) NOT NULL,
  password VARCHAR(254) NOT NULL
);

CREATE TABLE workout(
  workout_id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  w_name VARCHAR(255) NOT NULL,
  created  DATE NOT NULL DEFAULT CURRENT_DATE,
  account_id uuid NOT NULL,
  CONSTRAINT fk_account
  FOREIGN KEY(account_id)
  REFERENCES accounts(account_id)
);

CREATE TABLE exercise(
  ex_id INT NOT NULL,
  ex_name VARCHAR(255) NOT NULL,
  workout_id uuid NOT NULL,
  CONSTRAINT fk_workout
  FOREIGN KEY(workout_id)
  REFERENCES workout(workout_id),
  PRIMARY KEY(ex_id,workout_id)
);

CREATE TABLE sets(
  set_id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  s_order INT NOT NULL,
  reps INT NOT NULL,
  weight INT NOT NULL,
  w_unit VARCHAR(100) NOT NULL,
  r_unit VARCHAR(100) NOT NULL,
  ex_id INT NOT NULL,
  workout_id uuid NOT NULL,
  CONSTRAINT fk_exercise
  FOREIGN KEY(ex_id,workout_id)
  REFERENCES exercise(ex_id,workout_id)
);

CREATE TABLE session(
  session_id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  session_date DATE NOT NULL UNIQUE,
  account_id uuid NOT NULL,
  workout_id uuid NOT NULL,
  CONSTRAINT fk1 FOREIGN KEY (account_id)
  REFERENCES accounts (account_id),
  CONSTRAINT fk2 FOREIGN KEY (workout_id)
  REFERENCES workout (workout_id)
);

ALTER TABLE session ALTER COLUMN session_id SET NOT NULL;
ALTER TABLE session ALTER COLUMN session_id ADD GENERATED BY DEFAULT AS IDENTITY;
ALTER TABLE accounts ADD UNIQUE (session_date);
ALTER TABLE accounts ADD UNIQUE (email);

